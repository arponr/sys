require 'kramdown'

def texdown(i)
  env = {
    "align"       => [nil,           "Eq."],
    "definition"  => ["Definition",  "Df."],
    "definitions" => ["Definitions", "Df."],
    "equation"    => [nil,           "Eq."],
    "example"     => ["Example",     "Ex."],
    "examples"    => ["Examples",    "Ex."],
    "lemma"       => ["Lemma",       "Lm."],
    "proof"       => ["Proof",       "Pf."],
    "proposition" => ["Proposition", "Pr."],
    "remark"      => ["Remark",      "Rm."],
    "remarks"     => ["Remarks",     "Rm."],
    "theorem"     => ["Theorem",     "Th."],
  }

  puts i.gsub(%r{
    \\begin\{(#{Regexp.union(env.keys)})\}\s*
    (?:\[\s*(.*?)\s*\])?\s*
    (?:\{\s*(.*?)\s*\})?\s*
    (.*?)\s*
    \\end\{\1\}
  }xm) do
    e = env[$1]
    j = ""
    if e[0].nil?
      u = $3.nil? ? "#{$1}*" : $1
      j << "\\[\n\\begin{#{u}}\n"
      unless $3.nil?
        j << "\\tag{#{n}}\n"
        refs[$3] = "#{e[1]} #{n}"
        n += 1
      end
      j << "#{$3}\n\\end{#{u}}\n\\]\n"
      return j
    else
      j << "<div "
      j << "id=\"#{$3}\" " unless $3.nil?
      j << "class=\"environment #{e[0]}\">\n"
      j << "\#" * 6
      unless $3.nil?
        j << "#{n}. "
        refs[$3] = "#{e[1]} #{n}"
        n += 1
      end
      j << "#{e[0]}"
      j << ($2.nil? ? "\n" : " (#{$2})\n")
      j << "\n#{$4}\n</div>"
    end
    j
  end
end
