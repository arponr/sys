var Yoneda = {}

Yoneda.debug = true

Yoneda.UI = function() {
    var ui = this;
    
    $(document).ready(function() {
        var ui.$locs = {
            "left": $("#left"),
            "right": $("#right"),
            "main": $("#main"),
        };
        var ui.views = {};
        var ui.showing = {};

        ui.socket = new WebSocket(
            location.origin.replace(/^https?/,"ws") + "/socket",
        );
        ui.socket.onopen = init[document.body.id];
    });

    loginTmpl = [
        '<div id="login">',
        '    <header>',
        '        <h1>Yoneda</h1>',
        '        <h2>Fully faithful communication of mathematics, finally.</h2>',
        '    </header>',
        '',
        '    <div id="flashes"></div>',
        '',
        '    <input type="text" name="username" placeholder="username"',
        '           autocomplete="off" spellcheck="false">',
        '    <input type="password" name="password" placeholder="password"',
        '           autocomplete="off"',
        '    <input type="password" name="password_again" id="again"',
        '           placeholder="retype password" autocomplete="off">',
        '    <input type="submit" id="submit" value="login">',
        '    <input type="button" id="switch" value="need to register?">',
        '</div>',
    ].join('\n');

    function initLogin() {
        var el = $.parseHTML(loginTmpl)[0];
        var $el = $(el);
        var $sw = $el.find("#switch");
        var $login = $el.find("#login");
        var $submit = $el.find("#submit");
        var $again = $el.find("#again");

        $sw.click(function() {
            if ($again.is(":visible")) {
                $submit.val("login");
                login.attr(action: "/login");
                sw.val("need to register?");
                again.hide();
            } else {
                submit.val("register");
                login.attr(action: "/register");
                sw.val("already have an account?");
                again.show();
            }
        });

        v = new Yoneda.View({
            ui: ui,
            el: el,
            key: "login",
            loc: "left"
        });
        v.show();
    }
}

Yoneda.View = function(config) {
    this.ui = config.ui;
    this.el = config.el;
    this.$el = $(el);
    this.key = config.key;
    this.loc = config.loc;

    this.$el.addClass("view");
    this.ui.$locs[this.loc].append(this.$el);
    this.ui.views[this.key] = this;
}

Yoneda.View.prototype.flip = function() {
    var s = this.ui.showing[this.loc];
    if (s == this.key) return;
    this.ui.views[s].hide();
    this.show();
    this.ui.showing[this.loc] = this.key;
}

Yoneda.View.prototype.show = function() {
    this.$el.show();
}

Yoneda.View.prototype.hide = function() {
    this.$el.hide();
}
    

