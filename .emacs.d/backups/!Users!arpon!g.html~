<?php
/*
Template Name: Archives
*/
/**
 * The template for displaying Archive pages.
 *
 * Learn more: http://codex.wordpress.org/Template_Hierarchy
 *
 * @package Megna
 */

get_header(); ?>

<?php
  function echo_first_image( $postID ) {
    $args = array(
      'numberposts' => 1,
      'order' => 'ASC',
      'post_mime_type' => 'image',
      'post_parent' => $postID,
      'post_status' => null,
      'post_type' => 'attachment',
    );

    $attachments = get_children( $args );

    if ( $attachments ) {
      foreach ( $attachments as $attachment ) {
        $image_attributes = wp_get_attachment_image_src( $attachment->ID, 'thumbnail' ) ?
                            wp_get_attachment_image_src( $attachment->ID, 'thumbnail' ) :
                            wp_get_attachment_image_src( $attachment->ID, 'full' );
        echo '<img src="' . wp_get_attachment_thumb_url( $attachment->ID ) . '" class="current">';
      }
    }
    else {
      echo apply_filters('the_content', get_post_field('post_content', $postID));
    }
  }
?>


	<section id="primary" class="content-area">
		<div id="content" class="site-content" role="main">
			<div id="post-<?php the_ID(); ?>" <?php post_class(); ?>>    
  			<?php
			 $years = $wpdb->get_col("SELECT DISTINCT YEAR(post_date) FROM $wpdb->posts WHERE post_status = 'publish' ORDER BY post_date DESC");
			 foreach($years as $year) : ?>

     				<ul class="archive-month">
      				<?php
			 	 $months = $wpdb->get_col("SELECT DISTINCT MONTH(post_date) FROM $wpdb->posts WHERE post_status = 'publish' AND YEAR(post_date) = '".$year."' ORDER BY post_date DESC");
			 	 foreach($months as $month) : ?>

        			<li class="archive-month-el"><div class="archive-month-head"><?php echo date( 'F', mktime(0, 0, 0, $month) );?> <?php echo $year; ?></div>
         
					<ul class="archive-post">
          				<?php
				 	 $theids = $wpdb->get_results("SELECT ID, post_title FROM $wpdb->posts WHERE post_status = 'publish' AND MONTH(post_date)= '".$month."' AND YEAR(post_date) = '".$year."' AND post_type='post' ORDER BY post_date DESC");
				 	 foreach ($theids as $theid): ?>

            				<li class="archive-post-el">
					<div class="archive-prev"><?php echo_first_image($theid->ID); ?></div>
					<a href="<?php bloginfo('url'); ?>?p=<?php echo $theid->ID; ?>" class="archive-title">
						<?php echo $theid->post_title; ?>
					</a>
					</li>

           				<?php endforeach; ?>
					</ul>

				</li>   
			
				<?php endforeach;?>
				</ul>

    			<?php endforeach; ?>

			</div>

		</div><!-- #content -->
	</section><!-- #primary -->

<?php get_sidebar(); ?>
<?php get_footer(); ?>
