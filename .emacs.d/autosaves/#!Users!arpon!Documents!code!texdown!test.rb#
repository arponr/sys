require 'kramdown'

def texdown(input, indent)
  output = input.gsub(%r{
    ^ {#{3 * indent}}
    \\begin\{(#{Regexp.union(env.keys)})\}\s*
    (?:\[\s*(.*?)\s*\])?\s*
    (?:\{\s*(.*?)\s*\})?\s*
    (.*?)\s*
    \\end\{\1\}
  }ixm) do
    e = env[$1]
    j = ""
    if e[0].nil?
      u = $3.nil? ? "#{$1}*" : $1
      j << "\\[\n\\begin{#{u}}\n"
      unless $3.nil?
        j << "\\tag{1}\n"
      end
      j << "#{$4}\n\\end{#{u}}\n\\]\n"
    else
      j << "<div "
      j << "id=\"#{$3}\" " unless $3.nil?
      j << "class=\"environment #{e[0]}\">\n"
      j << "\#" * 6
      unless $3.nil?
        j << "#{n}. "
      end
      j << "#{e[0]}"
      j << ($2.nil? ? "\n" : " (#{$2})\n")
      j << "\n#{$4}\n</div>"
    end
    j
  end

  puts o
end
